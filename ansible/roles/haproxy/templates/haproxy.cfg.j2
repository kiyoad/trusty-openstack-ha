global
    log /dev/log	local0
    log /dev/log	local1 notice
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon
    pidfile /var/run/haproxy.pid
    # echo "help" | sudo socat stdio /var/lib/haproxy/stats
    stats socket /var/lib/haproxy/stats
    maxconn 4000

defaults
    log  global
    maxconn  4000
    option  redispatch
    retries  3
    timeout  http-request 10s
    timeout  queue 1m
    timeout  connect 10s
    timeout  client 1m
    timeout  server 1m
    timeout  check 10s

listen mysql
    bind {{ cluster_virtual_ip }}:3306
    mode tcp
    option mysql-check user haproxy
    balance roundrobin
    # mysql -h {{ cluster_virtual_ip }} -uroot -p<pass> -e "show variables like 'hostname'"
    server sv2 {{cluster_server_ips[1]}}:{{ mysql_port }} check port {{ mysql_port }} inter 5000 fall 2
    server sv3 {{cluster_server_ips[2]}}:{{ mysql_port }} check port {{ mysql_port }} inter 5000 fall 2 backup
    server sv1 {{cluster_server_ips[0]}}:{{ mysql_port }} check port {{ mysql_port }} inter 5000 fall 2 backup

listen rabbitmq
    bind {{ cluster_virtual_ip }}:5672
    mode tcp
    balance roundrobin
    timeout client 3h
    timeout server 3h
    option clitcpka
    server sv3 {{cluster_server_ips[2]}}:{{ rabbitmq_port }} check inter 5000 rise 2 fall 3
    server sv1 {{cluster_server_ips[0]}}:{{ rabbitmq_port }} check inter 5000 rise 2 fall 3 backup
    server sv2 {{cluster_server_ips[1]}}:{{ rabbitmq_port }} check inter 5000 rise 2 fall 3 backup
